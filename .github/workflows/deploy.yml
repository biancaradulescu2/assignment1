name: Deploy
on:
    workflow_run:
        workflows: ["Testing"]
        types: 
            - completed
        branches: master
    pull_request:
        types:
            - closed
jobs:
    deployment:
      environment: Prod
      env:
        MYSQL_ROOT_PASSWORD: ${{ secrets.MYSQL_ROOT_PASSWORD }}
        MYSQL_DATABASE: ${{ secrets.MYSQL_DATABASE }}
        MYSQL_USER: ${{ secrets.MYSQL_USER }}
        MYSQL_PASSWORD: ${{ secrets.MYSQL_PASSWORD }}
      runs-on: ubuntu-latest
      steps:
        - name: Install SSH Key
          uses: shimataro/ssh-key-action@v2
          with:
            key: ${{ secrets.ID_RSA }}
            known_hosts: 'placeholder'

        - name: Adding Known Host
          run: ssh-keyscan -H ${{ secrets.SSH_HOST }} >> ~/.ssh/known_hosts

        - name: Checkout code
          uses: actions/checkout@v4
          
        # - name: Copy files with SCP
        #   run: |
        #     scp -rv /home/runner/work/assignment1/assignment1 ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/home
        #     ls /home/runner/work/assignment1/assignment1/
        - name: Spin up containers
          run: |
            ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "cd assignment1; docker compose down; docker compose up --build -d"
        - name: Restore latest backup
          run: |
              ssh ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
                latest_backup=\$(ls -t ./backup/*.sql | head -n 1) &&
                docker exec -ti db bash -c 'mysql -h \$MYSQL_HOST -u $MYSQL_USER -p$MYSQL_PASSWORD $MYSQL_DATABASE < \$latest_backup'
              "
